# 微信服务号接入 ChatGPT 模型自动回复

notes:

嗨，大家好。最近 ChatGPT 火的不得了，是全世界的焦点。他打破了传统意义上的搜索答案的方式，而是对话的方式给出答案。相比较问答网站，或者 Google 等，完全降维打击。

当然个人也非常看好这个领域的发展，会引导很多世界的变革。

但由于很多原因，在中国使用从注册到稳定性来说，还是有很多限制。

做一期开发演示，把 ChatGPT 的服务接入微信公众号。利用微信公众号的沟通能力，做一个简单的问答功能。

关键字：Rust，Wechat，ChatGPT

---

# 项目开发前提准备

notes:

选用 3.5-turbo 的模型，他有更好的角色区分，可以不用把所有内容都按照对话的模式拼接，让 AI 理解。
这是使用 Rust 语言开发的 DEMO。

但开发整个项目，需要几个前提。

1. 微信公众号，订阅号就可以，他缺少一些高级功能，但可以完成基本的对话，包括图片。
2. 非国内节点的服务器。ChatGPT 的 API 还是受到了网络限制。
3. 数据库。不限，MYSQL、PostgreSQL、或者 NoSQL 的。
4. ChatGPT 的账号（TOKEN）

关键字：Rust，Wechat，ChatGPT，3.5-turbo，SQL

---

# Rust 基础

notes:

项目中关于 rust 的部分，使用的都是比较常用的框架的内容，这里不展开介绍，如果对基础概念不清楚的，可以看官方材料（https://www.rust-lang.org/）或者我之前的视频。

这里主要使用的框架是 Actix-web，数据库连接池使用 SqlX，连接 MySQL 数据库。Reqwest 用于外部 HTTP 调用。其他依赖包会随着项目开发中顺便引入。

项目中会会稍微讲解一些关于 Trait 的使用，包括常用的 ERROR 处理方式。

---

# 搭建项目结构

notes:

项目主要有三个核心动作。

1. 接受/回复 Wechat 的信息。
2. 调用/存储上下文记录。
3. 发送 ChatGPT 的 API 获得结果。

主要的项目结构也分为三个部分，Database，Wechat，ChatGPT

常见的方式使用 API 文件夹做外部调用，Dao 放数据库相关的配置和访问，项目比较小，就简化这个文件结构。

整个目录为

```
src
├──api
│   ├──wechat
│   └──chatgpt
├──settings
├──database
├──error
└──main

```

我们快速完成基本代码。

介绍 actix-web，config，log，缩略基本的项目功能，到方法调用。

配置文件还可以采用dotenv去管理环境变量。参数设置到环境变量中。

---

# Error 处理

notes:

关于 Error，为了简化代码中的错误的处理流程，把错误跑出来，在最上游的方法中统一处理并打印日志。常见的解决方案是使用 Error

```
    // impl From<serde_json::Error> for Error {
    //     fn from(err: serde_json::Error) -> Error {
    //         Error::JsonError(err)
    //     }
    // }

    #[error("json error: {0}")]
    JsonError(#[from] serde_json::Error),
```

还有其他的方法处理，就不深度展开了，可以自行学习。

---

# 集成微信公众号接口

notes:

> > https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html

1. 使用开发者模式
   1. 接入平台
   2. 验证签名
2. 完成一条消息回复

---

# 数据库的存储

notes:

本项目使用了MySQL的存储，为了演示，只存了用户的对话，用于结合上下文，生成token发送给chatgpt。

这里额外存了一个ChatGPT的响应时间。用来看一下网络访问的时长。

---

# Cache

notes:

由于微信公众号的基础消息要求回复时间在5秒内。而ChatGPT的时间现在还很慢，很多时候是超过了5秒钟，会超时。微信面对超时会重试两次。这两次的重试显然不能重复调用ChatGPT。所以增加了一个缓存，用来去重。

项目中使用的缓存比较简单，实际的项目中，可以考虑使用类似Redis等分布式的系统去做缓存处理。

我使用一个Hashmap，制作了一个简单的缓存。通过RwLock 保障了线程安全。
通过 get() 方法检查缓存中是否存在，并获取其过期时间。使用 set() 方法将数据存储到缓存中。
额外写了cleanup() 方法，通过定时器，定期检查所有键的过期时间，并删除过期的键值对。

---

# 调用 ChatGPT 的 AI 生成文字

notes:

3.5 的 api 介绍

> > https://platform.openai.com/docs/api-reference/chat/create

text_davinci_003 版本的开发。
代码仅供参考

这里讲解一下 trait 的使用

```
#[async_trait]
pub trait ChatApi {
    async fn send_message(
        &self,
        client: &Client,
        config: &ChatGptConfig,
        context: &Vec<Conversation>,
        message_from_user: &str,
    ) -> Result<String>;
}
```

```
    let api: Box<dyn ChatApi> = match app_state.chat_gpt_config.model.as_str() {
        "text-davinci-003" => Box::new(ChatGptTextDavinci003),
        "gpt-3.5-turbo" => Box::new(ChatGpt35Turbo),
        _ => return Ok(HttpResponse::BadRequest().finish()),
    };
    let message_from_chat = api
        .send_message(
            &app_state.client,
            &app_state.chat_gpt_config,
            &context,
            &wechat_message.content,
        )
        .await?;
```

你也可以把这部分包装到 model 方法内，对外用一个方法，屏蔽底层的模型实现细节。

---

# 项目测试和部署

notes:

1. 项目测试

其中cache和ChatGPT的Response结构体，添加了响应的测试项目。在Rust中，项目可以使用[test]关键字，在代码中直接进行单元测试，确保代码质量。

2. 部署

```
cargo build --release
nohup ./target/release/the-world &
```

也可以尝试部署在容器中，使用 ECS 等，降低服务成本。

---

# 总结和展望

notes:

微信公众号有自己的限制，比如5秒钟的响应时间，现在ChatGPT并不稳定，时间经常15s，20s，需要使用微信服务号的客服主动回复消息的功能，才会让体验更顺畅一些。

本视频通过微信公众号的回答场景，给体验一下ChatGPT的可能应用。作为技术人员，使用 Rust 也好，Golang 也好，都尽可能的快速使用它制作原型，尝试更多的可能性。

ChatGPT 这样的AI 越来越影响到大家的日常。很多初级的工作，类似代码编程，图片生成，影片剪辑脚本等，可能都会逐步被AI替代。就像工厂流水线会被自动化的机器取代，这是个必然趋势吧。

每一个技术人也要思考一下自身的技术价值。

今天的技术视频就讲到这里，

如果有任何问题或者意见，请留言给我。

---
